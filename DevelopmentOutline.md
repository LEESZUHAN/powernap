# PowerNap 開發大綱

## 第一階段：基礎設置與數據獲取
1. **專案架構設置**
   - 建立 Apple Watch 應用專案結構
   - 配置必要的權限（HealthKit、通知等）
   - 設置基本 UI 框架

2. **資料存取層實現**
   - 實現 HealthKit 連接，取得心率數據
   - 建立 CoreMotion 數據收集機制
   - 開發數據處理工具類（獲取靜息心率、活動級別）

3. **背景監測機制**
   - 實現 WKExtendedRuntimeSession 配置
   - 建立電池優化的數據收集策略
   - 開發感測器使用協調器

## 第二階段：睡眠監測演算法
1. **心率監測**
   - 獲取並存儲使用者靜息心率(RHR)基準值
   - 根據年齡組實現心率閾值判定（如18-59歲：低於RHR的90%）
   - 建立心率趨勢持續時間分析（如成人需維持3分鐘）
   - 開發特殊情況處理（如運動員RHR極低的情況）

2. **活動監測**
   - 實現動作監測演算法
   - 定義並調整 Motion_level 閾值
   - 建立動態活動窗口分析

3. **個人化心率模型**
   - 開發用戶睡眠心率數據收集機制
   - 實現基於歷史數據的閾值優化
   - 整合平均睡眠心率、最低心率和心率變異性指標
   - 建立模型定期更新機制

4. **綜合判定**
   - 整合心率與活動數據
   - 實現根據年齡組的持續時間判斷（2-4分鐘條件滿足）
   - 開發入睡偵測狀態機
   - 建立數據記錄與模型訓練機制

## 第三階段：計時與喚醒功能
1. **計時選項界面**
   - 開發 1-30 分鐘範圍的滾輪選擇器 UI
   - 實現自由時間選擇邏輯
   - 建立使用者設定儲存機制

2. **倒數計時機制**
   - 實現入睡後計時啟動邏輯
   - 開發背景計時器
   - 設計 UI 更新機制

3. **喚醒通知**
   - 實現 UNUserNotificationCenter 配置
   - 開發喚醒聲音與震動機制
   - 建立喚醒後數據摘要顯示

## 第四階段：UI設計與使用者體驗
1. **主介面設計**
   - 開發簡潔的啟動與設置界面
   - 實現計時進度顯示
   - 設計睡眠狀態反饋指示器
   - 加入年齡組選擇設定（影響判定閾值）

2. **錶盤複雜功能**
   - 開發 Complication 設計
   - 實現快速啟動機制
   - 建立複雜功能狀態更新邏輯

3. **交互優化**
   - 優化觸控操作
   - 改進狀態轉換動畫
   - 設計錯誤處理與引導

4. **基本視覺識別**
   - 設計基本 App Icon（符合 Apple 規範要求）
   - 確定應用主色調與基本色彩系統
   - 實現一致的視覺語言與圖標風格

## 第五階段：測試與優化
1. **功能測試**
   - 測試心率閾值判定準確性
   - 測試不同年齡組的入睡判定參數
   - 驗證不同時間選項的計時功能
   - 測試通知喚醒可靠性
   - **測試問題修復**：
     - 優化健康權限請求流程，添加初始引導畫面說明需要授權兩次的原因

2. **效能優化**
   - 分析與優化電池消耗
   - 改進背景執行效率
   - 優化感測器使用頻率
   - 實現異步操作優化
     - 重構 HealthKitService 異步處理
     - 優化 SleepDetectionService
     - 確保 PowerNapViewModel 的異步操作穩定性
     - 處理背景數據傳遞的異步問題
   - **設備特定優化**：
     - 針對 Series 6+ 設備優化內存使用
     - 確保大型數據結構有效釋放
     - 實施按需加載策略

3. **使用者測試**
   - 收集實際使用反饋
   - 調整演算法閾值
   - 改進使用者體驗

## 第六階段（選擇性）：增強功能
1. **數據統計與分析**
   - 開發入睡速度統計
   - 實現歷史記錄查看
   - 建立趨勢圖表顯示
   - 加入睡眠心率分析報告

2. **個人化設定**
   - 實現心率閾值微調界面
   - 開發自定義喚醒聲音
   - 建立個人化設定同步機制
   - 提供運動員特殊模式選項

3. **進階整合**
   - 實現健康應用數據共享
   - 開發與 iPhone 應用的深度整合
   - 建立雲端備份與同步機制

4. **視覺設計強化**
   - 設計與製作高品質 App Icon（含各尺寸規格）
   - 開發多主題視覺風格與色彩系統
   - 建立完整的視覺設計指南
   - 製作促銷與上架素材（螢幕截圖、預覽影片）

## 硬體兼容性測試計劃
- **目標最低支援**：Apple Watch Series 6+
- **測試環境**：優先使用 Series 9（實機）完成功能開發
- **兼容性測試**：在功能完成後使用各種模擬器測試基本功能
- **重點測試**：內存使用、UI響應性、算法執行時間

---

## 開發進度追蹤

### 第一階段
- [x] 專案架構設置
- [x] 資料存取層實現
- [x] 背景監測機制

### 第二階段
- [x] 心率監測 (已重新實現基於HR的檢測邏輯，完成)
  - [x] 獲取並存儲使用者靜息心率(RHR)基準值
  - [x] 根據年齡組實現心率閾值判定（如18-59歲：低於RHR的90%）
  - [x] 建立心率趨勢持續時間分析（如成人需維持3分鐘）
  - [x] 開發特殊情況處理（如運動員RHR極低的情況）
- [x] 活動監測
- [ ] 個人化心率模型 (需重建基於HR的模型，尚未實現自適應優化功能)
- [x] 綜合判定 (已更新以使用HR指標)

### 第三階段
- [x] 計時選項界面
- [x] 倒數計時機制
- [x] 喚醒通知

### 第四階段
- [x] 主介面設計
- [x] 錶盤複雜功能
- [x] 交互優化
- [x] 基本視覺識別

### 第五階段
- [ ] 功能測試
- [ ] 效能優化
- [ ] 使用者測試

### 第六階段
- [ ] 數據統計與分析
- [ ] 個人化設定
- [ ] 進階整合
- [ ] 視覺設計強化

## 里程碑

1. **MVP 版本** - 完成第一至第三階段的所有功能，具備基本的入睡偵測與喚醒功能
2. **Beta 版本** - 完成第四階段及第五階段的基本測試，UI 完善且穩定可用
3. **正式版本** - 完成第五階段的所有優化，準備上架
4. **進階版本** - 實現第六階段的增強功能（選擇性）

## 注意事項

- 各階段可能會根據實際開發情況進行調整
- 技術難點主要在於入睡偵測演算法和背景執行機制
- 請在每個功能點完成後進行充分測試
- 電池消耗是關鍵考量因素，應貫穿整個開發過程 