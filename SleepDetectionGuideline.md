# PowerNap 睡眠檢測機制說明

## 概述

PowerNap 應用使用多層次的檢測系統來準確判定用戶何時進入睡眠狀態，確保在用戶真正入睡後才開始計時。本文檔詳細說明了檢測機制的工作原理、關鍵參數和判定邏輯。

## 動作檢測機制

### 核心參數

| 參數 | 默認值 | 說明 |
|------|--------|------|
| motionThreshold | 0.02 | 動作閾值，低於此值視為靜止 |
| windowSize | 300 | 動作數據的觀察窗口大小（5分鐘） |
| shortWindowSize | 20 | 短時間觀察窗口（20秒），用於即時檢測 |
| autoAdjustThreshold | true | 是否啟用自適應閾值調整 |

### 動作數據處理流程

1. **數據採集**：
   - 使用加速度計每秒採集一次數據
   - 計算加速度向量大小：`sqrt(x*x + y*y + z*z) - 1.0`（扣除重力）
   - 取絕對值後保存為動作強度

2. **窗口平均處理**：
   - 長窗口（5分鐘）：用於穩定判定整體趨勢
   - 短窗口（20秒）：用於敏感捕捉突然變化

3. **靜止判定**：
   - 當窗口平均動作強度 < 動作閾值時，判定為靜止
   - 需要連續靜止120秒（2分鐘）才會觸發動作條件

4. **自適應閾值**：
   - 每分鐘根據最近的動作數據自動調整閾值
   - 調整公式：`平均動作值 + 標準差`
   - 限制範圍：0.015 ~ 0.05，確保閾值合理

## HRV 監測機制

### 核心參數

| 參數 | 默認值 | 說明 |
|------|--------|------|
| hrvThresholdMultiplier | 1.15 | HRV閾值倍數（基準值的1.15倍） |

### HRV 分析流程

1. **基準值獲取**：
   - 從HealthKit讀取用戶過去7天的HRV平均值
   - 作為個人化的基準線

2. **實時監測**：
   - 定期從HealthKit獲取最新的HRV數據
   - 將當前值與閾值（基準值×1.15）比較

3. **增幅判定**：
   - 當當前HRV ≥ 基準HRV × 1.15時，判定為HRV條件滿足
   - 表示副交感神經活動增加，用戶可能進入放鬆/睡眠狀態

## 睡眠狀態判定

### 狀態定義

PowerNap定義了四種睡眠狀態：

| 狀態 | 描述 | 轉換條件 |
|------|------|----------|
| 清醒 (Awake) | 用戶清醒活動狀態 | 初始狀態 |
| 潛在睡眠 (PotentialSleep) | 可能進入睡眠的過渡狀態 | 同時滿足HRV和動作條件 |
| 睡眠中 (Asleep) | 確認用戶已入睡 | 潛在睡眠持續3分鐘 |
| 被干擾 (Disturbed) | 睡眠被短暫干擾 | 睡眠中條件不再滿足 |

### 時間門檻參數

| 參數 | 值（秒） | 說明 |
|------|----------|------|
| sleepConfirmationTime | 180 | 需持續滿足睡眠條件的時間（3分鐘） |
| motionStillThresholdTime | 120 | 需保持靜止的時間（2分鐘） |

### 狀態轉換邏輯

1. **清醒 → 潛在睡眠**：
   - 同時滿足HRV條件和動作條件

2. **潛在睡眠 → 睡眠中**：
   - 持續滿足條件達到3分鐘（sleepConfirmationTime）
   - 此時記錄睡眠開始時間，觸發計時器開始倒數

3. **睡眠中 → 被干擾**：
   - 不再同時滿足HRV和動作條件

4. **被干擾 → 睡眠中**：
   - 重新滿足條件

5. **被干擾 → 清醒**：
   - 持續不滿足條件超過2分鐘

## 實現注意事項

1. **資源優化**：
   - 動作數據通過窗口處理減少噪音
   - 感測器採樣頻率均為1秒，平衡準確性和電池消耗

2. **穩健性設計**：
   - 通過多重時間門檻避免誤判
   - 從潛在睡眠到確認睡眠的3分鐘緩衝，降低誤報率

3. **適應性**：
   - 自適應動作閾值，適應不同用戶和環境
   - 個人化HRV基準線，考慮個體差異

## 診斷與調整

可通過以下信息診斷系統運行狀況：

1. **HRV數據**：
   - 基準值：`baselineHRV`
   - 當前值：`currentHrv`
   - 判定閾值：`baselineHRV * 1.15`

2. **動作數據**：
   - 當前動作水平：`currentMotionLevel`
   - 當前閾值：`motionThreshold`
   - 靜止持續時間：`stillDuration`

3. **睡眠狀態**：
   - 當前狀態：`currentSleepState`
   - 條件滿足狀況：`isHrvConditionMet`和`isMotionConditionMet`

---

*本文檔為PowerNap開發團隊內部參考資料，對應用的具體實現提供技術說明，可根據測試反饋進行調整。* 